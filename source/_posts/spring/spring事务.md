---
title: spring事务
date: 2017-12-01 17:40:32
tags: springframework
categories: spring
---
### 事务介绍
事务是一系列连贯的动作，这些动作要么全部完成，要么全部不起作用。具有ACID属性

#### Spring中的事务管理
spring在不同的事务管理API之上定义了一个抽象层。而应用程序开发人员不必了解底层的事务管理API，就可以使用Spring的事务管理机制。

Spring支持两种事务管理方式：

1. 编程式事务管理： 将事务管理代码嵌入到业务方法中来控制事务的提交和回滚，在编程式事务中，必须在每个业务操作中包含额外的事务管理代码

2. 申明式事务管理：它将事务管理代码从业务方法中分离出来，以声明的方式来实现事务管理。事务管理作为一种横切关注点，可以通过AOP方法模块化。Spring通过Spring AOP框架支持声明式事务管理

### Spring事务传播
当事务方法被另一个事务方法调用时，必须指定事务应该如何传播。例如：方法可能继续在现有事务中运行，也可能开启一个新事务，并在自己的事务中运行。

Spring定义了七种传播行为

| name                  | description                        |
|-----                  |:-----------------------------------|
| PROPAGATION_REQUIRED  |	如果当前没有事务，就新建一个事务，如果已经存在一个事务，加入到这个事务中|
| PROPAGATION_SUPPORTS  | 支持当前事务，如果当前没有事务，就以非事务方式执行 |
| PROPAGATION_MANDATORY | 使用当前的事务，如果当前没有事务，就抛出异常 |
| PROPAGATION_REQUIRES_NEW  | 新建事务，如果当前存在事务，把当前事务挂起 |
| PROPAGATION_NOT_SUPPORTED | 以非事务方式执行操作，如果当前存在事务，就把当前事务挂起 |
| PROPAGATION_NEVER | 以非事务方式执行，如果当前存在事务，则抛出异常 |
| PROPAGATION_NESTED | 如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与PROPAGATION_REQUIRED类似的操作 |

#### 编程式事务管理
在代码中显示的调用`beginTranscation()`、`commit()`、`rollback()`等事务管理相关的方法，我们可以在代码中灵活的配置事务，在底层，Spring仍然把事务操作委托给持久化框架来执行

如果在代码中调用`commit`等方法，逻辑就散落在代码中了，Spring还提供了`TranscationTemplate`模板回调模式

#### 声明式事务管理
Spring 的声明式事务管理在底层是建立在 AOP 的基础之上的。其本质是对方法前后进行拦截，然后在目标方法开始之前创建或者加入一个事务，在执行完目标方法之后根据执行情况提交或者回滚事务。
#### 并发事务导致的问题
- 脏读： 脏读发生在一个事务读取了另一个事务改写但尚未提交的数据时。如果改写在稍后被回滚了，那么第一个事务获取的数据就是无效的
- 不可重复读： 发生在一个事务执行相同的查询两次或两次以上，但是每次都得到不同的数据时。这通常是因为另一个并发事务在两次查询期间更新了数据
- 幻读： 与不可重复读类似。它发生在一个事务(T1)读取了几行数据，接着另一个并发事务(T2)插入了一些数据时。在随后的查询中，第一个事务(T1)就会发现多了一些原本不存在的记录

### 参考资料
- [spring 事务管理](http://blog.csdn.net/evankaka/article/details/45478007)
- [全面分析spring事务管理](https://www.ibm.com/developerworks/cn/education/opensource/os-cn-spring-trans/index.html)
---
title: 关于mysql中的锁
date: 2019-11-28 21:54:48
tags: mysql
categories: mysql
---
### 并发事务带来的问题

并发事务访问相同记录可大致分为三种情况:
1. 读-读：即并发事务相继读取相同的记录。

读取操作不会影响记录，并不会引发问题，所以允许这种情况的发生

2. 写-写：即并发事务相继对相同的记录做出改动。

这种情况下会发生脏写的问题，任何一种隔离级别都不允许这种问题的发生。所以在多个未提交事务相继对一条记录做改动时，需要让它们排队执行，这个排队的过程其实是通过锁来实现的。

3. 读-写 或 写-读：也就是一个事务进行读取操作，另一个进行改动操作

种情况下可能发生`脏读`、`不可重复读`、`幻读`的问题。

> 注意: 幻读问题的产生是因为某个事务读了一个范围的记录，之后别的事务在该范围内插入了新记录，该事务再次读取该范围的记录时，可以读到新插入的记录

#### 加锁解决并发写(脏写)

并发事务写-写情况下，会导致`脏写`的问题，这个在任何一种隔离级别下都是不允许发生的，所以在多个未提交事务相继对一条记录做改动时，需要让它们排队执行，这个排队的过程其实是通过锁来实现的。

事务执行前是没有锁的，也就是说一开始是没有锁结构和记录进行关联的， 当一个事务想对这条记录做改动时，首先会看看内存中有没有与这条记录关联的锁结构，当没有的时候就会在内存中生成一个锁结构与之关联。比方说事务T1要对这条记录做改动，就需要生成一个锁结构与之关联：

![](/images/mysql/mysql-lock.png)

锁里面包含了很多信息，这里只展示两个重要信息的含义:
- `trx信息`：代表这个锁结构是哪个事务生成的。
- `is_waiting`：代表当前事务是否在等待

当事务T1改动了这条记录后，就生成了一个锁结构与该记录关联，因为之前没有别的事务为这条记录加锁，所以is_waiting属性就是false，我们把这个场景就称之为获取锁成功，或者加锁成功，然后就可以继续执行操作了。

在事务T1提交之前，另一个事务T2也想对该记录做改动，那么先去看看有没有锁结构与这条记录关联，发现有一个锁结构与之关联后，然后也生成了一个锁结构与这条记录关联，不过锁结构的is_waiting属性值为true，表示当前事务需要等待，我们把这个场景就称之为获取锁失败，或者加锁失败，或者没有成功的获取到锁，如：

![](/images/mysql/mysql-lock-wait.png)

在事务T1提交之后，就会把该事务生成的锁结构释放掉，然后看看还有没有别的事务在等待获取锁，发现了事务T2还在等待获取锁，所以把事务T2对应的锁结构的is_waiting属性设置为false，然后把该事务对应的线程唤醒，让它继续执行，此时事务T2就算获取到锁了。

#### 解决脏读、不可重复读、幻读

- 方案一：读操作利用多版本并发控制（MVCC），写操作进行加锁

`MVCC`就是通过生成一个`ReadView`，然后通过`ReadView`找到符合条件的记录版本（历史版本是由undo日志构建的），其实就像是在生成`ReadView`的那个时刻做了一次时间静止（保存了一个快照），查询语句只能读到在生成`ReadView之`前已提交事务所做的更改，在生成`ReadView`之前未提交的事务或者之后才开启的事务所做的更改是看不到的。而写操作肯定针对的是最新版本的记录，读记录的历史版本和改动记录的最新版本本身并不冲突，也就是采用`MVCC`时，读-写操作并不冲突

- 方案二: 读写操作都进行加锁

如果我们的一些业务场景不允许读取记录的旧版本，而是每次都必须去读取记录的最新版本，比方在银行存款的事务中，你需要先把账户的余额读出来，然后将其加上本次存款的数额，最后再写到数据库中。在将账户余额读取出来后，就不想让别的事务再访问该余额，直到本次存款事务执行完成，其他事务才可以访问账户的余额。这样在读取记录的时候也就需要对其进行加锁操作，这样也就意味着读操作和写操作也像写-写操作那样排队执行

### 参考资料

- [掘金小册-MySQL是怎么运行的](https://juejin.im/book/5bffcbc9f265da614b11b731/section/5c42cf94e51d45524861122d)
- [mysql锁详解](http://www.cnblogs.com/luyucheng/p/6297752.html)
- [mysql优化笔记](http://www.jianshu.com/p/163c96983ca9)
- [mysql数据库锁定机制](http://www.cnblogs.com/ggjucheng/archive/2012/11/14/2770445.html)